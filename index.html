<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="css/fonts.css">
<link rel="stylesheet" type="text/css" href="css/dots.css">
<link rel="stylesheet" type="text/css" href="css/index.css">
</head>
<body>

<audio id="fg-audio">
  <source src="fg.mpeg" type="audio/mpeg">
</audio>
<audio id="bg-audio" loop>
  <source src="bg.mpeg" type="audio/mpeg">
</audio>

<div class="content">

  <!-- Welcome -->
  <div id="welcome" class="screen container">
    <div class="swipeable">
      <div class="panel">
        <h1>welcome to</h1>
      </div>
      <div class="panel">
        <h1>winwin zone</h1>
      </div>
      <div class="panel">
        <h1>Join Next session</h1>
        <div class="vcenter">
          <img class="img-swipe" src="imgs/swipe_agree_pink.png">
        </div>
        <h1>swipe right to join</h1>
      </div>        
    </div>
    <div class="swipeable"><h1>Joining...</h1></div>
  </div>

  <!-- Until next session -->
  <div id="til" class="screen">
    <div class="panel"><h1>Until next session</h1></div>
    <div class="panel"><h1 class="counter">00:00</h1></div>
    <div class="panel">
      <h1>Your spot is</h1>
      <!-- <div class="dots bluedot vcenter"><span></span></div> -->
    </div>
    <div class="panel">
      <h1>at the WINWIN.zone</h1>
    </div>
  </div>  

  <!-- Tutorial -->
  <div id="tutorial" class="screen vcenter">
    <div class="panel"><img class="tutorial" src="tutorial.gif" height="600px"><h1></h1></div>
  </div>

  <!-- Ready -->
  <div id="ready" class="screen container">
    <div class="swipeable"><h1>Disagree</h1></div>
    <div class="swipeable">
      <div class="panel">
        <h1>You are with</h1>
        <h1>3 people</h1>
        <h1>Do you want to start?</h1>
      </div>
      <div class="panel">
        <div class="vcenter">
          <img class="img-swipe" src="imgs/swipe_disagree_pink.png">
          <img class="img-swipe" src="imgs/swipe_agree_pink.png">
          <h1>Disagree / Agree</h1>
        </div>
      </div>
    </div>
    <div class="swipeable"><h1>Agree</h1></div>
  </div>  

  <!-- Statement/Question -->
  <div id="question" class="screen container">
    <div class="swipeable"><h1>Disagree</h1></div>
    <div class="swipeable">
      <div class="panel button yes vcenter">
        <div class="panel agree"><h1>agree</h1><br><br></div>
        <img class="img-swipe" src="imgs/swipe_agree_pink.png">
      </div>
      <div class="panel statement">
          <h2>Friends should be shamed for flying</h2>
      </div>
      <div class="panel"><h1 class="counter">00:00</h1></div>
      <div class="panel button no vcenter">
          <img class="img-swipe" src="imgs/swipe_disagree_pink.png"/>
          <h1>Disagree</h1>
      </div>
    </div>
    <div class="swipeable"><h1>Agree</h1></div>
  </div>

  <!-- Waiting -->
  <div id="waiting" class="screen">
    <div class="panel vcenter question">
        <h1>You responded</h1> 
    </div>
    <div class="panel vcenter question">
      <span class="answer yes">Agree</span>
      <div class="panel pleasewait">
        <h3>Other people are still responding...</h3>
      </div>  
    </div>   
  </div>  

  <!-- Prompt -->
  <div id="prompt" class="screen">
    <div class="panel vcenter question">
      <h1>You responded</h1> 
    </div>
    <div class="panel vcenter question">
      <span class="answer no">Disagree</span>
    </div>
    <div class="panel provide">
      <h3>Please provide a statement that explains your answer.</h3>
    </div>
    <div class="panel"><textarea placeholder="Write your statement here...."></textarea></div>
    <div class="panel button submit"><h1>Submit</h1></div>  
  </div> 

  <!-- Consensus -->
  <div id="consensus" class="screen container">
    <div class="swipeable">
      <div class="panel vcenter">
        <h1>You have</h1>
        <h1>consensus!!!!</h1>
      </div>
      <div class="panel vcenter consensustext">
        <p>
          You have at least reached 
          5 times consensus in this
          discussion.


          Although you might differ in
          opinions on this statement,
          you have discovered enough 
          common ground to make
          decisions together.
        </p>
      </div>  
      <div class="panel vcenter">
        <h1>Results</h1>
        <img class="img-swipe" src="imgs/swipe_agree_pink.png">
      </div>
    </div>
    <div class="swipeable"><h1>Results</h1></div>
  </div> 

  <!-- No consensus -->
  <div id="consensless" class="screen">
    <div class="panel vcenter">
      <div class="panel vcenter ">
        <h1>You unfortunately had no moments of consensus.</h1>
        <h1>üôÅüôÅüôÅ</h1>
      </div>  
    <div class="panel"><br><br><img class="img-swipe" src="imgs/swipe_agree_pink.png"><h1>try again</h1></div>  
    </div>
  </div>  

  <!-- Moments -->
  <div id="moments" class="screen">
    <div class="panel"><h1>Your moments of consensus.</h1></div>
    <div class="panel"><h1>üåàüåàüåà</h1></div>  
    <div class="panel vcenter moments">
      <ul>
        <li>00:01 friends should be shamed for flying and i am talking more and more blabla</li>
        <li>00:01 friends should be shamed for flying</li>
        <li>00:01 friends should be shamed for flying</li>
        <li>00:01 friends should be shamed for flying</li>
        <li>00:01 friends should be shamed for flying</li>
      </ul>
    </div>
  </div>
</div>
<script src="swipe.js"></script> 
<script>

(function() {

  let counter = 0
  let timerId

  function buttonAudio() {
    var audio = new Audio('fg.mpeg')
    audio.play()
  }

  function handleSwipe(screen, id) {
    console.log('handleSwipe', screen, id)
    document.querySelector(`#${id}`).classList.add('ubermate')
    if(screen == 1 && id == 'welcome') ws.send(JSON.stringify({ cmd: 'USER_HELLO' }))

  }

  function init() {
    document.addEventListener('swipe', e => {
      console.log('swipe', e.detail)
      console.log('swipe', e.explicitOriginalTarget.id)
      handleSwipe(e.detail, e.explicitOriginalTarget.id)
    })
  }

  function strPadLeft(str, pad, length) {
    return (new Array(length + 1).join(pad) + str).slice(-length)
  }

  function startTimer(t, elm) {
    counter = t
    timerId = setInterval(() => {
      const time = --counter
      const minutes = Math.floor(time / 60)
      const seconds = Math.floor(time - minutes * 60)
      console.log(minutes)
      console.log(seconds)
      const tstr = strPadLeft('' + minutes, '0', 2) +
        ":" +
        strPadLeft('' + seconds, '0', 2)
      console.log(tstr)
      elm.innerHTML = tstr
    }, 1000)
  }

  // Screen functions - JBG

  function hideAll() {
    if(timerId) clearInterval(timerId)
    const screens = document.querySelectorAll('.screen')
    screens.forEach(s => {
      s.classList.remove('ubermate')
      s.style.display = 'none'
    })
    document.querySelector('body').classList.remove('consensus')
  }

  function showWelcome() {
    setupSwipe('#welcome', 1)
    hideAll()
    document.querySelector('#welcome').style.display = 'flex'
  }

  function showTil(t) {
    hideAll()
    startTimer(t, document.querySelector('#til .counter'))
    document.querySelector('#til').style.display = 'block'
  }

  function showTutorial() {
    hideAll()
    document.querySelector('#tutorial').style.display = 'block'
  } 

  function showReady() {
    setupSwipe('#ready', 2)
    hideAll()
    document.querySelector('#ready').style.display = 'flex'
  }  

  function showQuestion() {
    setupSwipe('#question', 2)
    hideAll()
    startTimer(600, document.querySelector('#question .counter'))
    document.querySelector('#question').style.display = 'flex'
  }  

  function showWaiting() {
    hideAll()
    document.querySelector('#waiting').style.display = 'block'
  }  

  function showPrompt() {
    hideAll()
    document.querySelector('#prompt').style.display = 'block'
    document.querySelector('#prompt textarea').focus()
  } 

  function showConsensus() {
    setupSwipe('#consensus', 1)
    hideAll()
    document.querySelector('#consensus').style.display = 'flex'
    document.querySelector('body').classList.add('consensus')
  }  

  function showConsensless() {
    hideAll()
    document.querySelector('#consensless').style.display = 'block'
  } 

  function showMoments() {
    hideAll()
    document.querySelector('#moments').style.display = 'block'
    document.querySelector('body').classList.add('consensus')
  }          

  // Websocket stuff - JBG

  //const ws = new WebSocket('wss://winwin.peerparty.org/ws/')
  const ws = new WebSocket('ws://localhost:8000/')

  ws.onopen = function(e) {
    console.log('Websocket open.')
    //ws.send(JSON.stringify({ cmd: 'USER_HELLO' }))
  }

  ws.onclose = function(e) {
    console.log('Websocket closed.')
  }

  ws.onerror = function(e) {
    console.log('Websocket errored.')
  }

  ws.onmessage = function(e) {
    console.log(e.data)
    const res = JSON.parse(e.data)
    const cmd = res['cmd']
    switch(cmd) {
      case 'USER':
        userId = res['id']
        serverId = res['server_id']
        console.log('User id: ' + userId )
        showTil(((res['start_time'] * 1000) - Date.now()) / 1000)
        break
      case 'USER_QUESTION':
        startCounter(15)
        console.log('Question is: ' + res['txt'])
        showQuestion(res['txt'])
        break
      case 'USER_PROMPT':
        startCounter(30)
        console.log('Prompt for question: ' + res['txt'])
        showPrompt(res['txt'], res['ans'])
        break
      case 'USER_ANSWERS':
        startCounter(15)
        showInstruction("Waiting for everyone to make a choice...")
        break
      case 'USER_DONE':
        stopTimer()
        showInstruction("Done!")
        document.querySelector('#instruction').classList.remove('no')
        document.querySelector('#instruction').classList.remove('yes')
        document.querySelector('#instruction').classList.add('done')
        break
      case 'USER_JOIN':
        // Ask user if they would like to force start - JBG
        showInstruction("There are enough users to begin, shall we start?")
        break
      default:
        console.log('Unknown CMD: ' + cmd)
        break
    }
  }

  init()
  showWelcome()

})()

</script>
</body>
</html>


